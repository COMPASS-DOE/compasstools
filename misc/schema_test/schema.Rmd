---
title: "super simple schema"
author: "BBL"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(tidyr)
library(dplyr)
library(DT)
```

## Read the data

The **plot table** provides treatment/plot/individual information based on `design_link`.

```{r}
plot_data <- read_csv("plot_names.csv", show_col_types = FALSE)
datatable(plot_data) %>% 
    formatStyle("design_link", color = "red") %>% 
    formatStyle("logger", color = "green")
```

The **design table** links logger variables with their design (as specified in the plot table).

```{r}
design_data <- read_csv("design_document.csv", show_col_types = FALSE)
datatable(design_data) %>%
    formatStyle("design_link", color = "red") %>%
    formatStyle("loggernet_variable", color = "blue")
```

The **logger data table** is downloaded from the logger. 

```{r}
logger_data <- read_csv("logger_data.csv", show_col_types = FALSE)
datatable(logger_data) %>%
    formatStyle("logger", color = "green")
```

## Reshape logger data and join with design info

```{r}
logger_data %>% 
    pivot_longer(c(-logger, -timestamp), names_to = "loggernet_variable") %>%
    left_join(select(design_data, loggernet_variable, design_link, research_name),
              by = "loggernet_variable") ->
    dat1
datatable(dat1)
```

## Join with plot data

```{r}
dat1 %>% 
    left_join(plot_data, by = c("logger", "design_link")) ->
    dat2
datatable(dat2)
```

## Reshape for final output

```{r}
dat2 %>% 
    select(-design_link, -loggernet_variable) %>% 
    pivot_wider(names_from = "research_name", values_from = "value") %>% 
    datatable()
```

## A little test

```{r, include=FALSE}
test <- tibble(x = c("sapflux(1)", "sapflux(2:3)", "logger", "sapflux(4:6)"))
PATTERN <- "([[:digit:]]+:[[:digit:]]+)"
matches <- regexpr(PATTERN, test$x)
strings <- strsplit(regmatches(test$x, matches), ":")
seqs <- lapply(strings, function(x) seq(x[1], x[2]))

m <- 0
results <- list()
for(i in seq_along(matches)) {
    if(matches[i] <= 0) {
        results[[i]] <- test[i,]
    } else {
        m <- m + 1
        results[[i]] <- test[rep(i, length(seqs[[m]])),]
        results[[i]]$x <- stringr::str_replace(results[[i]]$x, PATTERN, as.character(seqs[[m]]))
    }
}


```

